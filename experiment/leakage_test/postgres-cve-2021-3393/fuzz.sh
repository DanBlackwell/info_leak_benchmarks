#!/bin/bash

re='^[0-9]+$'
if ! [[ $1 =~ $re ]] || [ $# -ne 1 ]; then
  echo "Usage: `basename $0` [number_of_seconds_to_run_AFL_for]"
  exit 0
fi

touch logfile
chmod 666 logfile
touch fuzzing.log
chmod 666 fuzzing.log
mkdir -p OUT
chown -R postgres OUT
su postgres -c "export PATH=$PATH:/usr/local/pgsql/bin/ && \
        export LD_LIBRARY_PATH=$LD_LIBRARY_PATH:/usr/local/pgsql/lib && \
        initdb -D /dev/shm/pgsql_data && \
        postgres -D /dev/shm/pgsql_data > logfile 2>&1 &"
su postgres -c "export PATH=$PATH:/usr/local/pgsql/bin/ && \
        export LD_LIBRARY_PATH=$LD_LIBRARY_PATH:/usr/local/pgsql/lib && \
        AFL_CUSTOM_MUTATOR_LIBRARY=/app/AFL_info_leakage/custom_mutators/Grammar-Mutator/libgrammarmutator-sql.so
/usr/bin/time -v timeout $1 afl-fuzz -i IN -o OUT -t 10000 -- ./fuzz > fuzzing.log 2>&1 & \
        wait"

cp fuzzing.log ../results/$(basename $PWD)_fuzzing.log
