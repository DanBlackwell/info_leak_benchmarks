#!/bin/bash

CFLAGS=""
ENV_VARS=""
EXTRA_FILES=""
CONFIG_FLAGS=""
if ! [[ -z "${VANILLA}" ]]; then
#  DFSan does not work with this target!
#  export CC="clang-dfsan"
#  export CXX="clang++-dfsan"
#  export CONFIG_FLAGS="--without-readline --without-zlib"
  export CC="afl-clang-fast"
  export CXX="afl-clang-fast++"
  export CFLAGS="-D VANILLA_AFL"
  ENV_VARS="AFL_USE_MSAN=1"

elif ! [[ -z "${CBMC}" ]]; then
  echo "BUILDING WITH CBMC"
  pushd repo
    ./configure $CONFIG_FLAGS 
    CC=goto-cc make && make install
  popd
  # goto-cc cbmc_harness.c --function cbmc_test -Irepo -lm -o test
  su postgres -c "export $ENV_VARS; goto-cc $CFLAGS cbmc_harness.c --function cbmc_test -I/usr/local/pgsql/include -L/usr/local/pgsql/lib -lpq -lm -o test"
  exit 0

else
  su postgres -c "gcc -O3 -c ../memory.c -o m.o; gcc -O3 -c ../decode_inputs.c -o d.o; gcc -O3 -c ../base64.c -o b.o; gcc -O3 -c ../json.c -o j.o"
  EXTRA_FILES="m.o d.o b.o j.o"
  export CC="afl-clang-fast"
  export CXX="afl-clang-fast++"
  CFLAGS="-Wl,--wrap=malloc"
fi

pushd repo
  ./configure $CONFIG_FLAGS && make && make install
popd

chmod 777 .

su postgres -c "export $ENV_VARS; $CC $CFLAGS fuzz_harness.c $EXTRA_FILES -I../ -I/usr/local/pgsql/include -L/usr/local/pgsql/lib -lpq -lm -Wall -o fuzz"
su postgres -c "rm -f *.o"
