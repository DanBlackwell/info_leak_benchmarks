#!/bin/bash

CFLAGS=""
EXTRA_FILES=""
if ! [[ -z "${VANILLA}" ]]; then
  CFLAGS="-D VANILLA_AFL"
  ENV_VARS="AFL_USE_MSAN=1"

elif ! [[ -z "${CBMC}" ]]; then
  echo "BUILDING WITH CBMC"
  CC=goto-cc
  pushd repo
    CC=$CC ./config && make
  popd
  goto-cc cbmc_harness.c --function cbmc_test -DCERT_PATH="./" repo/libssl.a repo/libcrypto.a -Irepo/include -lm -ldl -o test
  exit 0

else
  CFLAGS="-Wl,--wrap=malloc"

  gcc -O3 -c ../memory.c -o m.o
  gcc -O3 -c ../decode_inputs.c -o d.o
  gcc -O3 -c ../base64.c -o b.o
  gcc -O3 -c ../json.c -o j.o

  EXTRA_FILES="m.o d.o b.o j.o"
fi

pushd repo
  CC=afl-clang-fast ./config && make clean && make
popd

env $ENV_VARS afl-clang-fast $CFLAGS fuzz_harness.c $EXTRA_FILES -DCERT_PATH="./" repo/libssl.a repo/libcrypto.a -I../ -Irepo/include -lm -ldl -o fuzz

rm -f *.o
