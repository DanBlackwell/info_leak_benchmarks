#!/bin/bash

CFLAGS=""
EXTRA_FILES=""
if ! [[ -z "${VANILLA}" ]]; then
#  DFSan does not work with this target!
#  CC="clang-dfsan"
  CC="afl-clang-fast"
  CFLAGS="-D VANILLA_AFL"
  ENV_VARS="AFL_USE_MSAN=1"

elif ! [[ -z "${CBMC}" ]]; then
  goto-cc cbmc_harness.c repo/libnm-util/nm-param-spec-specialized.c \
  repo/libnm-util/nm-setting.c repo/libnm-util/nm-setting-vpn.c \
  -Irepo/libnm-util -I/usr/include/glib-2.0 \
  -I/usr/lib/x86_64-linux-gnu/glib-2.0/include/ -Irepo/include \
  -I/usr/include/dbus-1.0/ -I../ \
  -lglib-2.0 -ldbus-glib-1 -lgobject-2.0 -lm \
  --function cbmc_test \
  -o test
  exit 0

else
  CC="afl-clang-fast"
  CFLAGS="-fsanitize=fuzzer -Wl,--wrap=malloc"

  gcc -O3 -c ../memory.c -o m.o
  gcc -O3 -c ../decode_inputs.c -o d.o
  gcc -O3 -c ../base64.c -o b.o
  gcc -O3 -c ../json.c -o j.o

  EXTRA_FILES="m.o d.o b.o j.o"
fi

env $ENV_VARS $CC $CFLAGS fuzz_harness.c $EXTRA_FILES repo/libnm-util/nm-param-spec-specialized.c repo/libnm-util/nm-setting.c repo/libnm-util/nm-setting-vpn.c -Irepo/libnm-util -I/usr/include/glib-2.0 -I/usr/lib/x86_64-linux-gnu/glib-2.0/include/ -Irepo/include -I/usr/include/dbus-1.0/ -lglib-2.0 -ldbus-glib-1 -lgobject-2.0 -I../ -lm -o fuzz

rm -f *.o
