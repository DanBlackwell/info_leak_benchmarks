#!/bin/bash

re='^[0-9]+$'
if ! [[ $1 =~ $re ]] || [ $# -ne 1 ]; then
  echo "Usage: `basename $0` [number_of_seconds_to_run_AFL_for]"
  exit 0
fi

touch logfile
chmod 666 logfile
touch fuzzing.log
chmod 666 fuzzing.log
su postgres -c "export PATH=$PATH:/usr/local/pgsql/bin/ && \
        export LD_LIBRARY_PATH=$LD_LIBRARY_PATH:/usr/local/pgsql/lib && \
        initdb -D /usr/local/pgsql/data && \
        postgres -D /usr/local/pgsql/data > logfile 2>&1 &"
su postgres -c "export PATH=$PATH:/usr/local/pgsql/bin/ && \
        export LD_LIBRARY_PATH=$LD_LIBRARY_PATH:/usr/local/pgsql/lib && \
        ./fuzz < IN/4 &&
        AFL_CUSTOM_MUTATOR_LIBRARY=/app/Grammar-Mutator/libgrammarmutator-sql.so timeout $1 afl-fuzz -i IN -o OUT -- ./fuzz > fuzzing.log 2>&1 &"

