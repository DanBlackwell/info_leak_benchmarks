#!/bin/bash

CFLAGS=""
ENV_VARS=""
if [[ -v VANILLA ]]; then
  CFLAGS="-D VANILLA_AFL"
  ENV_VARS="AFL_USE_MSAN=1"
fi

pushd repo
  CC=/app/AFL_info_leakage/afl-clang-fast CXX=/app/AFL_info_leakage/afl-clang-fast++ ./configure && make && make install
popd

chmod 777 .

su postgres -c "gcc -c ../memory.c -o m.o; gcc -c ../decode_inputs.c -o d.o; gcc -c ../base64.c -o b.o; gcc -c ../json.c -o j.o"
su postgres -c "export $ENV_VARS; afl-clang-fast $CFLAGS fuzz_harness.c m.o d.o b.o j.o -I../ -I/usr/local/pgsql/include -L/usr/local/pgsql/lib -lpq -lm -Wall -o fuzz"
su postgres -c "rm *.o"

#su postgres -c 'PATH=$PATH:/usr/local/pgsql/bin/ LD_LIBRARY_PATH=$LD_LIBRARY_PATH:/usr/local/pgsql/lib initdb -D /usr/local/pgsql/data && (postgres -D /usr/local/pgsql/data > logfile 2>&1 &)'

# afl-fuzz -i IN/ -o OUT/ -x /app/AFL_info_leakage/dictionaries/sql.dict -- ./fuzz > fuzzing.log 2>&1
