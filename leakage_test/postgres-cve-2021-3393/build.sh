#!/bin/bash

CC=/app/AFL_info_leakage/afl-clang-fast CXX=/app/AFL_info_leakage/afl-clang-fast++ ./configure && make && make install

su postgres -c "AFL_USE_ASAN=1 afl-clang-fast fuzz_harness.c ../json.c ../base64.c ../memory.c ../decode_inputs.c -I../ -I/usr/local/pgsql/include -L/usr/local/pgsql/lib -lpq -lm -Wall -o fuzz"

su postgres -c 'PATH=$PATH:/usr/local/pgsql/bin/ LD_LIBRARY_PATH=$LD_LIBRARY_PATH:/usr/local/pgsql/lib (initdb -D /usr/local/pgsql/data && \
  (postgres -D /usr/local/pgsql/data > logfile 2>&1 &) && \
  afl-fuzz -i IN/ -o OUT/ -x /app/AFL_info_leakage/dictionaries/sql.dict -- ./fuzz > fuzzing.log);'
