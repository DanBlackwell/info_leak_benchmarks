// Copyright 2016 Google Inc. All Rights Reserved.
// Licensed under the Apache License, Version 2.0 (the "License");
#include <openssl/ssl.h>
#include <openssl/err.h>
#include <assert.h>
#include <stdint.h>
#include <stddef.h>
#include "decode_inputs.h"
#include "memory.h"

SSL_CTX *Init() {
  SSL_library_init();
  SSL_load_error_strings();
  ERR_load_BIO_strings();
  OpenSSL_add_all_algorithms();
  SSL_CTX *sctx;
  assert (sctx = SSL_CTX_new(TLSv1_method()));
  /* These two file were created with this command:
      openssl req -x509 -newkey rsa:512 -keyout server.key \
     -out server.pem -days 9999 -nodes -subj /CN=a/
  */
  assert(SSL_CTX_use_certificate_file(sctx, "runtime/server.pem",
                                      SSL_FILETYPE_PEM));
  assert(SSL_CTX_use_PrivateKey_file(sctx, "runtime/server.key",
                                     SSL_FILETYPE_PEM));
  return sctx;
}

int LLVMFuzzerTestOneInput(const uint8_t *Data, size_t Size) {
  uint8_t *public_in, *secret_in;
  uint32_t public_len, secret_len;
  find_public_and_secret_inputs((char *)Data, Size, &public_in, &public_len, &secret_in, &secret_len);

  uint32_t seed = 0;
  for (int i = 0; i < (secret_len < 4 ? secret_len : 4); i++) {
      seed |= secret_in[i] << 8 * i;
  }

  static SSL_CTX *sctx;
  sctx = Init();
  SSL *server = SSL_new(sctx);
  BIO *sinbio = BIO_new(BIO_s_mem());
  BIO *soutbio = BIO_new(BIO_s_mem());
  SSL_set_bio(server, sinbio, soutbio);
  SSL_set_accept_state(server);

  SEED_MEMORY(seed);
  fill_stack();

  BIO_write(sinbio, public_in, public_len);

  char *output = malloc(65 * 1024);
  int readLen = BIO_read(sinbio, output, 65 * 1024);

  printf("IN BIO: ");
  for (int i = 0; i < readLen; i++) {
    printf("%hhX", output[i]);
  }
  printf("\n");

  readLen = BIO_read(soutbio, output, 65 * 1024);
  printf("OUT BIO: ");
  for (int i = 0; i < readLen; i++) {
    printf("%hhX", output[i]);
  }
  printf("\n");

  free(output);   

  SSL_free(server);
  return 0;
}

